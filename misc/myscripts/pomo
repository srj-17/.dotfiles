#!/bin/bash

# Usage: script work_minutes break_minutes cycles message
# Example: ./pomo.sh 25 5 4 "Take a break"
# meaning pomo work_min break_min cycles msg_at_each_break_end

STATEFILE="/tmp/pomo_state"
NOTIFY_SOUND="$HOME/Music/noti_sound"

play_notification() {
    if [[ -f "$NOTIFY_SOUND" ]]; then 
        if command -v mpv &>/dev/null; then
            mpv --really-quiet "$NOTIFY_SOUND" &
        fi
    fi
}

# Check if there's an active session running
if [[ -f "$STATEFILE" ]]; then
    read end type < "$STATEFILE"
    now=$(date +%s)
    rem=$(( end - now ))

    if (( rem > 0 )); then
        if [[ "$type" == "work" ]]; then
            notify-send "Pomodoro running" \
                "$(printf 'Time remaining: %d minutes %d seconds' $((rem / 60)) $((rem % 60)))"
        else
            notify-send "Break running" \
                "$(printf 'Time remaining: %d minutes %d seconds' $((rem / 60)) $((rem % 60)))"
        fi
        play_notification
        exit 0
    else
        # Session expired, remove state file and continue to start new pomodoro
        rm -f "$STATEFILE"
    fi
fi

# If no active session, start new pomodoro as usual
work_min=${1:-60}
break_min=${2:-15}
cycles=${3:-4}
shift 3 || true
msg="${*:-Lets gooo!}"

work_sec=$((work_min * 60))
break_sec=$((break_min * 60))

# Start message
notify-send -u normal "Pomodoro started" \
    "$work_min min work / $break_min min break â€” $msg"
play_notification

for ((i=1; i<=cycles; i++)); do
    # Work session
    echo "$(( $(date +%s) + work_sec )) work" > "$STATEFILE"
    sleep "$work_sec" && \
    notify-send -u critical "Break time - $msg"
    play_notification

    # Break session (skip after final cycle)
    if [[ $i -lt $cycles ]]; then
        echo "$(( $(date +%s) + break_sec )) break" > "$STATEFILE"
        sleep "$break_sec" && \
        notify-send -u normal "Back to work!"
        play_notification
    fi
done

rm -f "$STATEFILE"  # Cleanup state file at end

notify-send -u normal "Pomodoro complete!" \
    "$cycles cycles finished"
play_notification
